<head><script src="http://d3js.org/d3.v3.js" charset="utf-8"></script></head>
<h1></h1>
<body>
<script type="text/javascript">
(function(){
    window.THEWEBSOCKET = new WebSocket("ws://blagdons-macbook-air-2.local:8001");
    window.onbeforeunload = function () { window.THEWEBSOCKET.close(); };

    var files = [];
    var want_file_pos = [];
    var w = window.innerWidth;
    var h = window.innerHeight;
    var xScale;

    var build_model = function (init_dict) {
        want_file_pos = init_dict["want_file_pos"];
        want_file_pos.forEach( function(want_index, i) {
            files[i] = {};
            var head_and_tail = init_dict["heads_and_tails"][i];
            files[i]["path"] = init_dict["files"][want_index]["path"];
            files[i]["relevant"] = [];  
            for (var j = head_and_tail[0]; j <= head_and_tail[1]; j++) {
                files[i]["relevant"].push(j);
            }
        });
        draw_svg();
    }



    var draw_svg = function () {
        xScale = d3.scale.linear()
                         .domain([0, d3.max(files, function (d) { return d["relevant"].length} )])
                         .range([0, w]);

        console.log("width: " + w, "height: "+ h);

        var svg = d3.select("body")
                    .append("svg")
                    .attr("width", w)
                    .attr("height", h);

        var bigRect = svg.append("rect")
                         .attr("x", 0)
                         .attr("y", 0)
                         .attr("width", w)
                         .attr("height", h)
                         .attr("fill", "blue")
                         .attr("opacity", 0.2);

        var clientCircle = svg.append("circle")
                              .attr("cx", Math.floor(w/2))
                              .attr("cy", Math.floor(h/2))
                              .attr("r", Math.floor(h/2))
                              .attr("fill", "olive")
                              .attr("stroke", "orange")
                              .attr("stroke-width", 5)
                              .attr("opacity", 0.2);

        var bars = svg.selectAll("rect")
                      .data(files)
                      .enter()
                      .append("rect")
                      .attr("y", function (d, i) { return (60 + i * 60); })
                      .attr("x", 50)
                      .attr("width", function (d) { return xScale(d["relevant"].length); })
                      .attr("height", 20)
                      .attr("fill", "red")
                      .attr("opacity", 0.2);
    }

    var vis_request = function (req_dict) {
        console.log(req_dict);
    }

    var vis_write = function (write_dict) {
        var piece_index = write_dict["piece_index"];
        // Want to find which files care about piece_index
        for (file_index in files) {
            var internal_index = files[file_index]["relevant"].indexOf(piece_index);
            console.log(internal_index);
            if ( internal_index !== -1) {
                // TODO -- add transition code here
                console.log(files[file_index]["path"] + ' cares about ' + piece_index);
            }
        };
    }

    window.THEWEBSOCKET.onmessage = function (message) {
        var meat = JSON.parse(message.data);
        console.log(meat["kind"]);
        if (meat["kind"] === "init") {
            build_model(meat);
        } else if (meat["kind"] === "request") {
            vis_request(meat);
        } else if (meat["kind"] === "piece") {
            vis_write(meat);
        } else {
            throw "Data kind invalid";
        }
        // var h = document.getElementsByTagName('h1')[0];
        // h.innerHTML = meat["kind"];
    }

    document.onclick = function () { window.THEWEBSOCKET.send('o hai there') };
}) ();
</script>
</body>
